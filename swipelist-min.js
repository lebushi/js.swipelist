
/**
* @author Stephan Reich (2012)
*
*/

function SwipeList(){var startIndex=0,visibleElements=5;var outerElement;var selectElement=true;var selectIndexOffset=2;var selectedIndex=1+selectIndexOffset;var elementWidth,containerWidth,elementNum,elementContainer,currentOffset,outerElement;var firstElement,lastElement;var startX=0;var firstIndex=0,lastIndex=0,indexOffset=0,tempOffset=0,leftOffset=0;var selectCallback,styleCallback;var data;var defaults={styleCallback:false,selectCallback:false,index:0,fullscreen:false,elementHTML:false,selectOnDrag:true,tolerance:10,preventDragExceptions:"",switchOnDrag:true}var touchMode=false;var indexSwitched=true;var tempIndex=-1;function calcSelectedIndex(){var middle=containerWidth/2;var offset;var value=elementNum-1;$.each($(".sliderElement",outerElement),function(i,element){offset=$(this).offset().left-outerElement.offset().left;if(middle-offset<elementWidth){value=i;return false}value=i});if(value!=tempIndex){indexSwitched=true;tempIndex=value}return value}function handleIndexSelection(){selectedIndex=calcSelectedIndex();if(defaults.switchOnDrag)selectIndex(selectedIndex,defaults.selectOnDrag)}function selectIndex(index,callCallback){if(indexSwitched){$(".selected",outerElement).removeClass("selected");getElementByIndex(index).addClass("selected");if(selectCallback&&callCallback){var globalIndex=getElementByIndex(index).data("index");selectCallback.call(this,data[globalIndex],globalIndex);indexSwitched=false}}}var canMove=false;function move(e){function calcTempOffset(){if(touchMode){tempOffset=e.originalEvent.touches[0].pageX-startX}else{tempOffset=e.clientX-startX}}if(!$(e.target).hasClass(defaults.preventDragExceptions))e.preventDefault();if(!canMove){if(!touchMode){if(Math.abs(toleranceStartX-e.clientX)>defaults.tolerance)canMove=true}else{if(Math.abs(toleranceStartX-e.originalEvent.touches[0].pageX)>defaults.tolerance)canMove=true}}if(canMove){handleIndexSelection();calcTempOffset();firstIndex=firstElement.data("index")-1;lastIndex=lastElement.data("index")+1;if(tempOffset>0&&(firstIndex>=0||(firstIndex==-1&&defaults.endless))){if((firstIndex==-1&&defaults.endless))firstIndex=lastIndex-1;for(var i=0;i<tempOffset/elementWidth;i++){updateElement(lastElement,firstIndex);setOffset(tempOffset-elementWidth);elementContainer.prepend(lastElement);startX+=elementWidth;indexSwitched=true;firstElement=getFirstElement();lastElement=getLastElement();firstIndex=firstElement.data("index")-1;if(firstIndex==-1)break;calcTempOffset()}}else if(tempOffset<-1*elementWidth&&(lastIndex<elementNum||(lastIndex>=elementNum&&defaults.endless))){if((lastIndex>=elementNum&&defaults.endless)){lastIndex=0}for(var i=0;i<Math.abs(tempOffset)/elementWidth;i++){updateElement(firstElement,lastIndex);setOffset(tempOffset+elementWidth);startX-=elementWidth;elementContainer.append(firstElement);indexSwitched=true;if(i>0)console.log("shaky?");firstElement=getFirstElement();lastElement=getLastElement();lastIndex=lastElement.data("index")+1;if(lastIndex>=elementNum)break;calcTempOffset()}}else{setOffset(tempOffset)}}}var toleranceStartX=0;function start(e){if(e.originalEvent&&e.originalEvent.touches)touchMode=true var half=elementWidth/2;if(visibleElements==1)half=0;if(touchMode){startX=e.originalEvent.touches[0].pageX-parseInt(elementContainer.css("left"))-half;toleranceStartX=e.originalEvent.touches[0].pageX}else{startX=e.clientX-parseInt(elementContainer.css("left"))-half;toleranceStartX=e.clientX}if(defaults.tolerance==0)canMove=true;$(document).bind("mousemove touchmove",move);$(document).bind("mouseup touchend",stop)}function setOffset(offset){elementContainer.css("left",offset-leftOffset+"px");currentOffset=offset-leftOffset}function stop(){$(document).unbind("mousemove touchmove",move);$(document).unbind("mouseup touchend",stop);if(canMove){var offset=getCSSOffset();var newOffset=(containerWidth/2)-(selectedIndex)*elementWidth-elementWidth/2;elementContainer.animate({left:newOffset},400,function(){selectIndex(calcSelectedIndex(),true)});canMove=false}}function getFirstElement(){return $(".sliderElement",outerElement).first()}function getLastElement(){return $(".sliderElement",outerElement).last()}function getElementByIndex(index){return $(".sliderElement",outerElement).eq(index)}function getCSSOffset(){return parseInt(elementContainer.css("left"))}function calcElementWidth(){if(!defaults.fullscreen){var tempEl=$("<div class='sliderElement'></div>");elementContainer.append(tempEl);var elWidth=tempEl.width();tempEl.remove();return elWidth+2}else{return outerElement.width()}}function calcVisibleElements(){return Math.ceil(containerWidth/elementWidth)}function createElement(index){var element=$('<div class="sliderElement"></div>');if(defaults.elementHTML)element.append(defaults.elementHTML);if(defaults.fullscreen)element.width(outerElement.width());updateElement(element,index);return element}function updateElement(element,index){element.data("index",index);if(styleCallback)styleCallback.call(this,data[index],element,data)}return{init:function(listData,target,options){$.extend(defaults,options);outerElement=target;data=listData;elementNum=listData.length;elementContainer=$(".sliderInner",target);containerWidth=outerElement.width();elementWidth=calcElementWidth();currentOffset=getCSSOffset();leftOffset=(elementWidth%containerWidth)/2;startIndex=defaults.index;selectedIndex=startIndex;selectCallback=defaults.selectCallback;styleCallback=defaults.styleCallback;visibleElements=calcVisibleElements();elementContainer.width(elementWidth*(visibleElements+3));selectIndexOffset=parseInt(visibleElements/2)-1;this.setIndex(startIndex);var that=this;$(window).resize(function(){postInit()});window.onorientationchange=function(){postInit()};function postInit(){if(defaults.fullscreen)elementWidth=calcElementWidth();containerWidth=outerElement.width();leftOffset=(containerWidth%elementWidth)/2;visibleElements=calcVisibleElements();that.setIndex(selectedIndex)}outerElement.bind("mousedown touchstart",start)},setIndex:function(index,callCallback){$(".sliderElement",elementContainer).remove();if(index>elementNum)index=elementNum-1;if(elementNum<visibleElements+2){var i=0;var iEnd=i+elementNum;indexOffset=0}else if(index<=visibleElements/2){var i=0;var iEnd=i+visibleElements+2;indexOffset=0}else if(index+visibleElements/2>elementNum){var i=elementNum-visibleElements-2;var iEnd=i+visibleElements+2;indexOffset=i}else{var i=index-parseInt(visibleElements/2)-1;var iEnd=i+visibleElements+2;indexOffset=i}for(i;i<iEnd;i++){elementContainer.append(createElement(i))}firstElement=getFirstElement();lastElement=getLastElement();setOffset((containerWidth/2)-(index-indexOffset)*elementWidth-elementWidth/2+leftOffset);indexSwitched=true;selectIndex(index-indexOffset,callCallback)},setData:function(listData){index=0;data=listData;elementNum=listData.length;startIndex=defaults.index;this.setIndex(0,false)},setSelectOnDrag:function(value){defaults.selectOnDrag=value},getSelectedElement:function(){return getElementByIndex(selectedIndex)},getSelectedIndex:function(){return selectedIndex},getSelectedDataIndex:function(){return data[getElementByIndex(selectedIndex).data("index")]}}}